<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chef Tools â€” Menu Planner, Converter & Prep/Par</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="manifest" href="manifest.json"/>
  <meta name="description" content="Unified static app with Menu Planner, Ingredient Converter and Prep/Par list management, switchable via tabs."/>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <h1>Chef Tools</h1>
      <p>Menu Planner, Ingredient Converter & Prep/Par Manager</p>
    </div>

    <!-- Tabs -->
    <nav class="tabbar" role="tablist" aria-label="Chef Tools tabs">
      <button id="tabbtn-menu" class="tab active" data-tab="menu"
              role="tab" aria-selected="true" aria-controls="tab-menu">
        Menu Planner
      </button>
      <button id="tabbtn-converter" class="tab" data-tab="converter"
              role="tab" aria-selected="false" aria-controls="tab-converter">
        Ingredient Converter
      </button>
      <button id="tabbtn-preppar" class="tab" data-tab="preppar"
              role="tab" aria-selected="false" aria-controls="tab-preppar">
        Prep &amp; Par List
      </button>
        <button id="tabbtn-catalog" class="tab" data-tab="catalog"
                role="tab" aria-selected="false" aria-controls="tab-catalog">
          Catalog
        </button>
    </nav>
  </header>

  <main class="app-main">

    <!-- MENU PLANNER TAB -->
    <section id="tab-menu" class="tab-content active" role="tabpanel" aria-labelledby="tabbtn-menu">
      <h2>Menu Planner</h2>
      <p class="intro">
        Build a menu, assign ingredients with per-menu-item amounts and units, set your expected diners,
        then generate a shopping list with pricing. Your ingredient catalog & recipes are saved locally.
      </p>

      <!-- Menu Section -->
      <section id="menu-section">
        <h3>Menu Items</h3>
        <p>Enter the menu items for your event. Each menu item has a name and optional description.</p>
        <!-- Search bar for Menu Items -->
        <div class="search-bar">
          <input type="text" id="menu-search" placeholder="Search menu items"/>
        </div>
        <table id="menu-table">
          <thead>
            <tr>
              <th>Menu Item Name</th>
              <th>Description</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- rows injected -->
          </tbody>
        </table>
        <button id="add-dish-btn" class="add-btn">Add Menu Item</button>
      </section>

      <!-- Ingredients Section -->
      <section id="ingredients-section">
        <h3>Ingredients</h3>
        <p>Assign ingredients to each menu item along with the amount needed per menu item and its unit.</p>
        <!-- Search bar for Ingredients assignment -->
        <div class="search-bar">
          <input type="text" id="ingredients-search" placeholder="Search ingredients"/>
        </div>
        <table id="ingredients-table">
          <thead>
            <tr>
              <th>Menu Item</th>
              <th>Ingredient</th>
              <th>Amount</th>
              <th>Unit</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- rows injected -->
          </tbody>
        </table>
        <button id="add-ingredient-btn" class="add-btn">Add Ingredient</button>
      </section>

      <!-- Event Templates Section -->
      <section id="templates-section">
        <h3>Event Templates</h3>
        <div class="template-controls" style="display:flex; flex-wrap: wrap; gap: 8px; align-items: center;">
          <input type="text" id="template-name" placeholder="Template name" style="flex:1; min-width:160px; padding:0.3rem"/>
          <button id="save-template-btn" class="secondary-btn">Save Template</button>
          <label style="display:flex; align-items:center; gap:4px;">
            <span>Load Template:</span>
            <select id="template-select" style="min-width:160px;"></select>
          </label>
          <button id="load-template-btn" class="secondary-btn">Load</button>
        </div>
        <p class="help">Templates save your menu items, ingredient assignments and guest headcount.</p>
      </section>

      <!-- Guest Headcount Section -->
      <section id="seats-section">
        <h3>Guest Headcount:</h3>
        <input type="number" id="expected-seats" min="1" value="1" />
      </section>

      <!-- Generate Shopping List Button -->
      <section id="generate-section">
        <button id="generate-btn" class="primary-btn">Generate Shopping List</button>
      </section>

      <!-- Shopping List Section -->
      <section id="shopping-section">
        <h3>Shopping List</h3>
        <p>Select how you plan to purchase each ingredient (number and type of unit) and enter a price.
        Prices are saved to the catalog and reused next time.</p>
        <table id="shopping-table">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Total Needed</th>
              <th>Unit</th>
              <th>Number of Units</th>
              <th>Type of Unit</th>
              <th>Price</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <!-- rows injected -->
          </tbody>
        </table>
        <button id="clear-shopping-btn" class="secondary-btn">Clear Shopping List</button>
      </section>

      <!-- Ingredient Catalog Section -->
      <section id="catalog-section">
        <h3>Ingredient Catalog</h3>
        <p>The catalog stores prices per unit for ingredients. Entries are automatically created when you add prices in the shopping list.</p>
        <table id="catalog-table">
          <thead>
            <tr>
              <th>Ingredient</th>
              <th>Number of Units</</th>
              <th>Unit</th>
              <th>Price per Unit</th>
            </tr>
          </thead>
          <tbody>
            <!-- rows injected -->
          </tbody>
        </table>
      </section>
    </section>

    <!-- INGREDIENT CONVERTER TAB -->
    <section id="tab-converter" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-converter" hidden>
      <h2>Ingredient Converter</h2>
      <p class="intro">
        Convert metric weights or volume to US cups / tbsp / tsp for common ingredients.
        Add your own densities (grams per US cup). Saved in your browser.
      </p>

      <div id="debugBanner" role="status" aria-live="polite" class="debug-banner" style="display:none"></div>

      <section class="card">
        <div class="controls">
          <button id="addRowBtn">âž• Add Ingredient</button>
          <button id="copyTableBtn">ðŸ“‹ Copy All</button>
          <button id="exportCSVBtn">ðŸ’¾ Export CSV</button>
          <div class="flex-spacer"></div>
          <label class="muted"><input id="autoConvertToggle" type="checkbox" checked> Auto-convert</label>
        </div>

        <div class="table-wrapper">
          <table id="convTable" aria-label="Ingredient conversions">
            <thead>
              <tr>
                <th class="col-ingredient">Ingredient</th>
                <th class="col-amount">Amount</th>
                <th class="col-unit">Unit</th>
                <th class="col-conversions">Conversions</th>
                <th class="col-actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <p class="help">Tip: type an override name to label copies and exports. Add custom densities below.</p>
      </section>

      <section class="card">
        <h3 style="margin:0 0 8px 0">Dry Ingredients by Weight</h3>
        <p class="help">Add/edit densities (grams per US cup) for dry ingredients. Only ingredients marked as dry will appear here. Data saved in your browser.</p>

        <div class="dense-row">
          <input id="newIngName" type="text" placeholder="Ingredient name" class="grow"/>
          <input id="newIngDensity" type="number" placeholder="g per cup" class="w-140"/>
          <button id="addIngredientBtn">âž• Add</button>
        </div>

        <div id="ingList" class="ing-list"></div>

        <div class="dense-row top-gap">
          <button id="resetDefaults" class="secondary">Reset Defaults</button>
          <button id="clearStorage" class="secondary outline">Clear Saved</button>
        </div>

        <div class="saved-count"><strong>Saved ingredients:</strong> <span id="savedCount" class="muted"></span></div>
      </section>
      <!-- New section for converting other types of food products (liquids and miscellaneous ingredients) -->
      <section class="card">
        <h3 style="margin:0 0 8px 0">Other Food Conversions</h3>
        <p class="help">Convert between common volume and fluid units (e.g. cups, liters, tablespoons).</p>
        <div class="dense-row">
          <input id="otherConvAmount" type="number" placeholder="Amount" class="w-120" />
          <select id="otherConvFrom"></select>
          <span>â†’</span>
          <select id="otherConvTo"></select>
          <button id="otherConvBtn" class="secondary">Convert</button>
        </div>
        <p id="otherConvResult" class="help" style="margin-top:8px"></p>
      </section>

      <!-- Custom Units Section -->
      <section class="card">
        <h3 style="margin:0 0 8px 0">Custom Units</h3>
        <p class="help">Define your own weight or volume units for conversions. Enter the unit name and its factor relative to grams or milliliters.</p>
        <div class="dense-row">
          <select id="customUnitType">
            <option value="weight">Weight (g)</option>
            <option value="volume">Volume (ml)</option>
          </select>
          <input id="customUnitName" type="text" placeholder="Unit name" class="grow"/>
          <input id="customUnitFactor" type="number" min="0" step="any" placeholder="Factor" class="w-140"/>
          <button id="addCustomUnit" class="secondary">âž• Add Unit</button>
        </div>
        <div id="customUnitsList" class="ing-list" style="margin-top:8px;"></div>
      </section>
    </section>

    <!-- PREP & PAR LIST TAB -->
    <!--
      This tab hosts the Prep & Par List management tool. The entire user interface from the standalone
      Prep & Par app has been relocated here. It includes a context bar for selecting date, location and shift,
      a dynamic main region for dashboards, item management, recipe editing, par template editing, modifier settings,
      exporting worksheets, uploading onâ€‘hand data (via CSV or OCR), generating prep lists and viewing history.
    -->
    <section id="tab-preppar" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-preppar" hidden>
      <!-- Context for Prep & Par: select date, location and shift -->
      <section class="context">
        <label>Date
          <input type="date" id="ctx-date">
        </label>
        <label>Location
          <input id="ctx-location" placeholder="e.g., Main Kitchen" list="known-locations">
          <datalist id="known-locations"></datalist>
        </label>
        <label>Shift
          <input id="ctx-shift" placeholder="e.g., Lunch, Dinner" list="known-shifts">
          <datalist id="known-shifts"></datalist>
        </label>
        <button id="ctx-save" class="primary">Set Context</button>
      </section>

      <!-- Subnavigation for Prep & Par views.  These buttons switch between the different
           views (dashboard, items, recipes, par templates, export, upload, generate and history).
           Using data-view attributes allows the main app script to route accordingly.
        -->
      <nav class="subnav" aria-label="Prep & Par navigation">
        <button class="nav-btn" data-view="dashboard" aria-selected="true">Dashboard</button>
        <!-- Place Menu Items immediately after Dashboard for intuitive workflow -->
        <button class="nav-btn" data-view="menuitems" aria-selected="false">Menu Items</button>
        <button class="nav-btn" data-view="items" aria-selected="false">Prep Items</button>
        <button class="nav-btn" data-view="recipes" aria-selected="false">Recipes</button>
        <button class="nav-btn" data-view="par" aria-selected="false">Par List</button>
        <button class="nav-btn" data-view="export" aria-selected="false">Export Worksheet</button>
        <button class="nav-btn" data-view="upload" aria-selected="false">Upload Onâ€‘Hand</button>
        <button class="nav-btn" data-view="generate" aria-selected="false">Generate Prep</button>
        <button class="nav-btn" data-view="history" aria-selected="false">History</button>
      </nav>

      <main id="view-root"><!-- dynamic views render here --></main>
      <!-- Template definitions from the Prep & Par app -->
      <template id="tmpl-dashboard">
        <div class="panel">
          <h2>Dashboard</h2>
          <div class="grid-3">
            <div class="card">
              <h3>Quick Actions</h3>
              <div class="stack">
                <button data-jump="par" class="secondary">Edit Par List (ctx)</button>
                <button data-jump="export" class="secondary">Export Onâ€‘Hand Worksheet (ctx)</button>
                <button data-jump="upload" class="secondary">Upload Onâ€‘Hand (CSV/OCR)</button>
                <button data-jump="generate" class="secondary">Generate Prep (ctx)</button>
              </div>
            </div>
            <div class="card">
              <h3>Stats (Context)</h3>
              <div id="dash-stats">â€”</div>
            </div>
            <div class="card">
              <h3>Recent History</h3>
              <div id="dash-history">â€”</div>
            </div>
          </div>
        </div>
      </template>
      <template id="tmpl-items">
        <div class="panel">
          <h2>Prep Items</h2>
          <div class="toolbar">
            <button id="add-item" class="primary">Add Prep Item</button>
            <button id="export-items" class="secondary">Export Prep Items JSON</button>
            <label class="filelike">
              Import Prep Items JSON
              <input type="file" id="import-items" accept="application/json">
            </label>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Prep Item</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Station</th>
                <th>Locations</th>
                <th>Default Batch Yield</th>
                <th>Notes</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="items-rows"></tbody>
          </table>
        </div>
      </template>
      <template id="tmpl-recipes">
        <div class="panel">
          <h2>Recipes</h2>
          <div class="toolbar">
            <button id="add-recipe" class="primary">Add Recipe</button>
            <button id="export-recipes" class="secondary">Export Recipes JSON</button>
            <label class="filelike">
              Import Recipes JSON
              <input type="file" id="import-recipes" accept="application/json">
            </label>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Prep Item</th>
                <th>Yield Amount</th>
                <th>Yield Unit</th>
                <th>Ingredients (amount unit name)</th>
                <th>Instructions</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="recipes-rows"></tbody>
          </table>
        </div>
      </template>
      <template id="tmpl-par">
        <div class="panel">
        <h2>Par List</h2>
        <div class="toolbar">
            <button id="add-par-line" class="primary">Add Line</button>
            <button id="save-par" class="secondary">Save List (ctx)</button>
            <button id="export-par" class="secondary">Export Par Lists JSON</button>
            <label class="filelike">
              Import Par Lists JSON
              <input type="file" id="import-par" accept="application/json">
            </label>
          </div>
          <div class="note">Par list applies to current <strong>Location</strong> &amp; <strong>Shift</strong> in the context bar.</div>
          <table class="table">
            <thead>
              <tr>
                <th>Station</th>
                <th>Menu Item</th>
                <th>Prep Item</th>
                <th>Unit</th>
                <th>Par Amount</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="par-rows"></tbody>
          </table>
        </div>
      </template>
      <template id="tmpl-modifiers">
        <div class="panel">
          <h2>Perâ€‘Shiftâ€‘Perâ€‘Day Modifiers</h2>
          <div class="note">Percent modifiers by weekday for the selected <strong>Location</strong> &amp; <strong>Shift</strong>.</div>
          <div class="toolbar">
            <button id="save-modifiers" class="primary">Save Modifiers (ctx)</button>
            <button id="export-modifiers" class="secondary">Export Modifiers JSON</button>
            <label class="filelike">
              Import Modifiers JSON
              <input type="file" id="import-modifiers" accept="application/json">
            </label>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Weekday</th>
                <th>Percent (e.g., 20 for +20%)</th>
              </tr>
            </thead>
            <tbody id="mod-rows"></tbody>
          </table>
        </div>
      </template>
      <template id="tmpl-export">
        <div class="panel">
          <h2>Export Onâ€‘Hand Worksheet</h2>
          <p>This exports a CSV staff can fill out digitally, or you can print it (File â†’ Print) for handwriting.</p>
          <div class="toolbar">
            <!-- Export on-hand list as an Excel (.xlsx) file instead of CSV. -->
            <button id="export-onhand-xlsx" class="primary">Download XLSX (ctx)</button>
            <button id="print-worksheet" class="secondary">Print Worksheet (ctx)</button>
          </div>
          <!-- Update the note to reflect the simplified CSV columns.  The context (date, location, shift) and ID columns are implicit in the file name. -->
          <div class="note">Columns: station, Menu Item, Prep Item, unit, par, on_hand</div>
          <div id="worksheet-preview"></div>
        </div>
      </template>
      <template id="tmpl-upload">
        <div class="panel">
          <h2>Upload Onâ€‘Hand (CSV or OCR)</h2>
          <div class="grid-2">
            <div class="card">
              <h3>CSV Upload (preferred)</h3>
              <label class="filelike">
                Choose CSV
                <input type="file" id="upload-csv" accept=".csv,text/csv">
              </label>
              <div id="csv-status">â€”</div>
            </div>
            <div class="card">
              <h3>Photo/PDF OCR</h3>
              <label class="filelike">
                Choose Image/PDF
                <input type="file" id="upload-ocr" accept="image/*,application/pdf">
              </label>
              <div id="ocr-status">â€”</div>
              <div class="note">After OCR, you can fix lowâ€‘confidence cells before saving.</div>
            </div>
          </div>
          <div id="upload-review"></div>
        </div>
      </template>
      <template id="tmpl-generate">
        <div class="panel">
          <h2>Generate Prep List</h2>
          <div class="toolbar">
            <button id="calc-prep" class="primary">Calculate (ctx)</button>
            <button id="export-prep-csv" class="secondary">Export Prep CSV</button>
            <button id="finalize-prep" class="secondary">Finalize &amp; Save to History</button>
          </div>
          <table class="table">
            <thead>
            <tr>
                <th>Station</th>
                <th>Prep Item</th>
                <th>Unit</th>
                <th>Par</th>
                <th>Onâ€‘Hand</th>
                <th>Needed</th>
                <th>Batch Yield</th>
                <th>Suggested Prep</th>
                <th>Assigned To</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="prep-rows"></tbody>
          </table>
        </div>
      </template>
      <template id="tmpl-history">
        <div class="panel">
          <h2>History</h2>
          <div class="toolbar">
            <button id="export-history" class="secondary">Export Full History JSON</button>
            <label class="filelike">
              Import History JSON
              <input type="file" id="import-history" accept="application/json">
            </label>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th>Date</th><th>Location</th><th>Shift</th><th>Type</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="hist-rows"></tbody>
          </table>
        </div>
      </template>

      <!-- Menu Items view for Prep & Par.  Allows editing of menu items directly within the
           Prep & Par workflow.  Menu Items define dishes composed of prep items and/or
           ingredients.  Each menu item has a name, description and list of components
           specified as quantity, unit and name. -->
      <template id="tmpl-menuitems">
        <div class="panel">
          <h2>Menu Items</h2>
          <div class="toolbar">
            <button id="add-menu-item" class="primary">Add Menu Item</button>
            <button id="export-menu-items" class="secondary">Export Menu Items JSON</button>
            <label class="filelike">
              Import Menu Items JSON
              <input type="file" id="import-menu-items" accept="application/json">
            </label>
          </div>
          <table class="table">
            <thead>
              <!-- Updated columns: separate prep items, other/garnish and price -->
              <tr><th>Name</th><th>Description</th><th>Prep Items</th><th>Other/Garnish</th><th>Price</th><th></th></tr>
            </thead>
            <tbody id="menuitems-rows"></tbody>
          </table>
        </div>
      </template>
    </section>

    <!-- CATALOG TAB -->
    <!--
      This section hosts the Data Catalog, which provides unified management for all core objects: Ingredients,
      Prep Items, Recipes and Menu Items.  Users can add, edit and delete entries and these entries are shared
      across the Menu Planner, Ingredient Converter and Prep & Par tools.  A sub-navigation allows switching
      between the object types.
    -->
    <section id="tab-catalog" class="tab-content" role="tabpanel" aria-labelledby="tabbtn-catalog" hidden>
      <h2>Data Catalog</h2>
      <p class="intro">
        Manage shared data across all tools. Create and edit Ingredients, Prep Items, Recipes and Menu Items here.
      </p>
      <nav class="subcatalog" aria-label="Catalog subnav">
        <button class="catalog-btn" data-category="ingredients" aria-selected="true">Ingredients</button>
        <button class="catalog-btn" data-category="prepItems" aria-selected="false">Prep Items</button>
        <button class="catalog-btn" data-category="recipes" aria-selected="false">Recipes</button>
        <button class="catalog-btn" data-category="menuItems" aria-selected="false">Menu Items</button>
      </nav>
      <section id="catalog-ingredients" class="catalog-content">
        <!-- Content for ingredients will be rendered by script.js -->
      </section>
      <section id="catalog-prepItems" class="catalog-content" hidden>
      </section>
      <section id="catalog-recipes" class="catalog-content" hidden>
      </section>
      <section id="catalog-menuItems" class="catalog-content" hidden>
      </section>
    </section>

  </main>

  <footer class="app-footer">
    <p>Data is saved locally in your browser. To start over, clear your local storage. <span class="version">v0.5.0</span></p>
  </footer>

  <script src="script.js"></script>
  <!-- Load Prep & Par logic after Chef Tools scripts -->
  <script src="app.js"></script>
  <!-- Embed the Data Catalog logic inline.  This avoids reliance on an external catalog.js file
       which some browsers may not load due to caching or crossâ€‘origin restrictions.  The content
       below is copied from catalog.js and wrapped in an IIFE. -->
  <script>
  /* Data Catalog Module for Chef Tools

     This script implements a unified data management interface across the
     Menu Planner, Ingredient Converter and Prep & Par tools.  It defines
     shared objects (Ingredients, Prep Items, Recipes and Menu Items) and
     provides UI for adding, editing and deleting entries.  Entries are
     saved in browser localStorage using `ct_*` keys.  Changes to Prep
     Items and Recipes are optionally synchronized with the Prep & Par
     state if it is available on the global `window.state`.

     The catalog UI lives inside the `<section id="tab-catalog">` in
     index.html.  A subnavigation bar lets users switch between object
     types.  Each object type has its own table and controls.  The
     script does not require any build step and runs in modern browsers.
  */
  (function() {
    // Storage keys for unified objects
    const STORE_KEYS = {
      ingredients: 'ct_ingredients_v1',
      prepItems: 'ct_prepItems_v1',
      recipes: 'ct_recipes_v1',
      menuItems: 'ct_menuItems_v1'
    };
    // Load a category from localStorage, falling back to provided default
    function loadCategory(cat, fallback) {
      const key = STORE_KEYS[cat];
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch (e) {
        console.warn('Failed to load category', cat, e);
        return fallback;
      }
    }
    // Save a category back to localStorage.  Also notify other
    // modules (Menu Planner, Prep & Par) to reload unified data if
    // appropriate.  Ingredients saving triggers density sync to the
    // Ingredient Converter.  Menu items saving triggers a reload of
    // unified catalog into the Menu Planner so that newly created or
    // updated menu items appear across all tools.
    function saveCategory(cat) {
      const key = STORE_KEYS[cat];
      localStorage.setItem(key, JSON.stringify(data[cat]));
      // If the ingredients category was saved, also sync densities to the legacy
      // converter key so that Ingredient Converter sees updated values.  This
      // maps unified ingredient objects (name, density) into a simple object
      // keyed by name -> density and stores it under 'chef_ing_densities_v1'.
      if (cat === 'ingredients') {
        syncIngredientDensities();
      }
      // Notify the Menu Planner and other tools to reload unified data
      // whenever ingredients or menu items are saved.  This ensures a
      // cohesive data model across the toolset.  The global function
      // `menuPlannerSyncFromUnifiedCatalog` is defined in script.js.
      if (cat === 'ingredients' || cat === 'menuItems') {
        if (typeof window.menuPlannerSyncFromUnifiedCatalog === 'function') {
          window.menuPlannerSyncFromUnifiedCatalog();
        }
      }
      // Refresh Prep & Par views if currently displaying menu items or
      // par lists.  This allows any changes to unified menu items to
      // propagate immediately.  The `currentView` and `routeTo` are
      // defined in app.js.  We check existence defensively.
      if (cat === 'menuItems') {
        try {
          if (typeof window.currentView !== 'undefined' && typeof window.routeTo === 'function') {
            if (window.currentView === 'menuitems' || window.currentView === 'par') {
              window.routeTo(window.currentView);
            }
          }
        } catch (err) {
          // ignore if not available
        }
      }
    }
    // Global data store
    const data = {
      ingredients: loadCategory('ingredients', []),
      prepItems: loadCategory('prepItems', []),
      recipes: loadCategory('recipes', []),
      menuItems: loadCategory('menuItems', [])
    };
    /*
      Sync ingredient densities to the legacy converter key.  The Ingredient
      Converter reads densities from `chef_ing_densities_v1` in localStorage.
      Whenever the unified ingredients are saved or modified, call this to
      update that key.  It constructs a simple object of {name: density}.
    */
    function syncIngredientDensities() {
      try {
        const out = {};
        data.ingredients.forEach(ing => {
          // Only sync densities for ingredients marked as dry (used by weight)
          if (ing && typeof ing.name === 'string' && ing.density != null && ing.dry) {
            out[ing.name] = ing.density;
          }
        });
        localStorage.setItem('chef_ing_densities_v1', JSON.stringify(out));
      } catch (err) {
        console.warn('Failed to sync ingredient densities to converter', err);
      }
    }
    // DOM references
    const tab = document.getElementById('tab-catalog');
    if (!tab) return; // Catalog tab might not exist
    const navButtons = Array.from(tab.querySelectorAll('.catalog-btn'));
    const sections = {
      ingredients: document.getElementById('catalog-ingredients'),
      prepItems: document.getElementById('catalog-prepItems'),
      recipes: document.getElementById('catalog-recipes'),
      menuItems: document.getElementById('catalog-menuItems')
    };
    // Activate category handler
    function activateCategory(cat) {
      navButtons.forEach(btn => {
        const selected = btn.dataset.category === cat;
        btn.classList.toggle('active', selected);
        btn.setAttribute('aria-selected', String(selected));
      });
      Object.keys(sections).forEach(key => {
        const section = sections[key];
        if (!section) return;
        section.hidden = key !== cat;
      });
      renderCategory(cat);
    }
    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        activateCategory(btn.dataset.category);
      });
    });
    // Render category
    function renderCategory(cat) {
      if (cat === 'ingredients') return renderIngredients();
      if (cat === 'prepItems') return renderPrepItems();
      if (cat === 'recipes') return renderRecipes();
      if (cat === 'menuItems') return renderMenuItems();
    }
    /* ------------------ Ingredients ------------------ */
    function renderIngredients() {
      const container = sections.ingredients;
      if (!container) return;
      container.innerHTML = '';
      // Toolbar
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Ingredient';
      addBtn.className = 'primary';
      addBtn.onclick = () => {
        data.ingredients.push({ name: '', density: null, price: null });
        saveCategory('ingredients');
        renderIngredients();
      };
      const exportBtn = document.createElement('button');
      exportBtn.textContent = 'Export JSON';
      exportBtn.className = 'secondary';
      exportBtn.onclick = () => {
        const json = JSON.stringify(data.ingredients, null, 2);
        downloadFile('ingredients.json', 'application/json', json);
      };
      const importLabel = document.createElement('label');
      importLabel.className = 'filelike';
      importLabel.textContent = 'Import JSON';
      const importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.accept = 'application/json';
      importInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const txt = await file.text();
        try {
          data.ingredients = JSON.parse(txt);
        } catch (err) {
          alert('Failed to parse JSON');
          return;
        }
        saveCategory('ingredients');
        renderIngredients();
      };
      importLabel.appendChild(importInput);
      toolbar.appendChild(addBtn);
      toolbar.appendChild(exportBtn);
      toolbar.appendChild(importLabel);
      container.appendChild(toolbar);
      // Table
      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = '<thead><tr><th>Name</th><th>g per cup</th><th>Price per Unit</th><th>Dry?</th><th></th></tr></thead>';
      const tbody = document.createElement('tbody');
      data.ingredients.forEach((ing, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-k="name" value="${ing.name || ''}"></td>
          <td><input type="number" min="0" step="any" data-k="density" value="${ing.density ?? ''}"></td>
          <td><input type="number" min="0" step="any" data-k="price" value="${ing.price ?? ''}"></td>
          <td><input type="checkbox" data-k="dry" ${ing.dry ? 'checked' : ''}></td>
          <td><button data-act="del" class="secondary">Delete</button></td>
        `;
        tr.oninput = (ev) => {
          const el = ev.target;
          const k = el.dataset.k;
          if (!k) return;
          if (k === 'name') ing.name = el.value;
          else if (k === 'density') ing.density = el.value === '' ? null : Number(el.value);
          else if (k === 'price') ing.price = el.value === '' ? null : Number(el.value);
          else if (k === 'dry') ing.dry = el.checked;
          saveCategory('ingredients');
        };
        tr.querySelector('button[data-act="del"]').onclick = () => {
          data.ingredients.splice(idx, 1);
          saveCategory('ingredients');
          renderIngredients();
        };
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    /* ------------------ Prep Items ------------------ */
    function renderPrepItems() {
      const container = sections.prepItems;
      if (!container) return;
      container.innerHTML = '';
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Prep Item';
      addBtn.className = 'primary';
      addBtn.onclick = () => {
        const id = `prep_${Date.now()}`;
        data.prepItems.push({ id: id, name: '', type: 'recipe', unit: '', unitCount: 1, station: '', locations: [], notes: '' });
        saveCategory('prepItems');
        // Synchronize with prep & par items if state is available
        if (typeof window.state !== 'undefined' && window.state.items) {
          window.state.items.push({ id: id, name: '', type: 'recipe', unit: '', station: '', locations: [], default_batch_yield: null, notes: '' });
          if (typeof window.persistAll === 'function') window.persistAll();
        }
        renderPrepItems();
      };
      const exportBtn = document.createElement('button');
      exportBtn.textContent = 'Export JSON';
      exportBtn.className = 'secondary';
      exportBtn.onclick = () => {
        downloadFile('prepItems.json', 'application/json', JSON.stringify(data.prepItems, null, 2));
      };
      const importLabel = document.createElement('label');
      importLabel.className = 'filelike';
      importLabel.textContent = 'Import JSON';
      const importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.accept = 'application/json';
      importInput.onchange = async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const txt = await f.text();
        try {
          data.prepItems = JSON.parse(txt);
        } catch (err) {
          alert('Failed to parse JSON');
          return;
        }
        saveCategory('prepItems');
        // Replace prep & par items
        if (typeof window.state !== 'undefined' && window.state.items) {
          window.state.items = data.prepItems.map(it => {
            return {
              id: it.id,
              name: it.name,
              type: it.type,
              unit: it.unit,
              station: it.station,
              locations: it.locations || [],
              default_batch_yield: it.type === 'recipe' ? (it.unitCount || null) : null,
              notes: it.notes || ''
            };
          });
          if (typeof window.persistAll === 'function') window.persistAll();
        }
        renderPrepItems();
      };
      importLabel.appendChild(importInput);
      toolbar.appendChild(addBtn);
      toolbar.appendChild(exportBtn);
      toolbar.appendChild(importLabel);
      container.appendChild(toolbar);
      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = '<thead><tr><th>Name</th><th>Type</th><th>Unit</th><th>Unit Count</th><th>Station</th><th>Locations</th><th>Notes</th><th></th></tr></thead>';
      const tbody = document.createElement('tbody');
      data.prepItems.forEach((it, idx) => {
        if (it.unitCount === undefined) it.unitCount = 1;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-k="name" value="${it.name || ''}"></td>
          <td><select data-k="type">
              <option value="recipe" ${it.type === 'recipe' ? 'selected' : ''}>recipe</option>
              <option value="mechanical" ${it.type === 'mechanical' ? 'selected' : ''}>mechanical</option>
          </select></td>
          <td><input type="text" data-k="unit" value="${it.unit || ''}"></td>
          <td><input type="number" min="1" step="1" data-k="unitCount" value="${it.unitCount ?? 1}"></td>
          <td><input type="text" data-k="station" value="${it.station || ''}"></td>
          <td><input type="text" data-k="locations" value="${(it.locations || []).join(', ')}"></td>
          <td><input type="text" data-k="notes" value="${it.notes || ''}"></td>
          <td><button data-act="del" class="secondary">Delete</button></td>
        `;
        tr.oninput = (ev) => {
          const el = ev.target;
          const k = el.dataset.k;
          if (!k) return;
          if (k === 'locations') it.locations = el.value.split(',').map(s => s.trim()).filter(Boolean);
          else if (k === 'unitCount') it.unitCount = Number(el.value) || 1;
          else it[k] = el.value;
          saveCategory('prepItems');
          // sync change to prep & par items
          if (typeof window.state !== 'undefined' && window.state.items) {
            const item = window.state.items.find(x => x.id === it.id);
            if (item) {
              item.name = it.name;
              item.type = it.type;
              item.unit = it.unit;
              item.station = it.station;
              item.locations = it.locations;
              item.notes = it.notes;
              if (it.type === 'recipe') item.default_batch_yield = it.unitCount;
              if (typeof window.persistAll === 'function') window.persistAll();
            }
          }
        };
        tr.querySelector('button[data-act="del"]').onclick = () => {
          data.prepItems.splice(idx, 1);
          saveCategory('prepItems');
          if (typeof window.state !== 'undefined' && window.state.items) {
            window.state.items = window.state.items.filter(x => x.id !== it.id);
            if (typeof window.persistAll === 'function') window.persistAll();
          }
          renderPrepItems();
        };
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    /* ------------------ Recipes ------------------ */
    function renderRecipes() {
      const container = sections.recipes;
      if (!container) return;
      container.innerHTML = '';
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Recipe';
      addBtn.className = 'primary';
      addBtn.onclick = () => {
        const newId = `recipe_${Date.now()}`;
        const firstPrep = data.prepItems[0];
        data.recipes.push({ id: newId, prepItemId: firstPrep ? firstPrep.id : '', yieldAmount: null, yieldUnit: '', ingredients: [], instructions: '' });
        saveCategory('recipes');
        syncRecipeYields();
        renderRecipes();
      };
      const exportBtn = document.createElement('button');
      exportBtn.textContent = 'Export JSON';
      exportBtn.className = 'secondary';
      exportBtn.onclick = () => {
        downloadFile('recipes.json', 'application/json', JSON.stringify(data.recipes, null, 2));
      };
      const importLabel = document.createElement('label');
      importLabel.className = 'filelike';
      importLabel.textContent = 'Import JSON';
      const importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.accept = 'application/json';
      importInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const txt = await file.text();
        try {
          data.recipes = JSON.parse(txt);
        } catch (err) {
          alert('Failed to parse JSON');
          return;
        }
        saveCategory('recipes');
        syncRecipeYields();
        renderRecipes();
      };
      importLabel.appendChild(importInput);
      toolbar.appendChild(addBtn);
      toolbar.appendChild(exportBtn);
      toolbar.appendChild(importLabel);
      container.appendChild(toolbar);
      const table = document.createElement('table');
      table.className = 'table';
      table.innerHTML = '<thead><tr><th>Prep Item</th><th>Yield Amount</th><th>Yield Unit</th><th>Ingredients (amount unit name)</th><th>Instructions</th><th></th></tr></thead>';
      const tbody = document.createElement('tbody');
      data.recipes.forEach((rec, idx) => {
        const tr = document.createElement('tr');
        const ingStr = (rec.ingredients || []).map(i => `${i.amount} ${i.unit} ${i.name}`).join(' | ');
        tr.innerHTML = `
          <td><select data-k="prepItemId">
            ${data.prepItems.map(pi => `<option value="${pi.id}" ${rec.prepItemId === pi.id ? 'selected' : ''}>${pi.name || pi.id}</option>`).join('')}
          </select></td>
          <td><input type="number" min="0" data-k="yieldAmount" value="${rec.yieldAmount ?? ''}"></td>
          <td><input data-k="yieldUnit" value="${rec.yieldUnit || ''}"></td>
          <td><textarea data-k="ingredients">${ingStr}</textarea></td>
          <td><textarea data-k="instructions">${rec.instructions || ''}</textarea></td>
          <td><button data-act="del" class="secondary">Delete</button></td>
        `;
        tr.oninput = (ev) => {
          const el = ev.target;
          const k = el.dataset.k;
          if (!k) return;
          if (k === 'ingredients') {
            rec.ingredients = el.value.split('|').map(s => s.trim()).filter(Boolean).map(seg => {
              const parts = seg.split(/\s+/);
              const amt = Number(parts.shift());
              const u = parts.shift() || '';
              const nm = parts.join(' ');
              return { amount: amt, unit: u, name: nm };
            });
          } else if (k === 'yieldAmount') {
            rec.yieldAmount = el.value === '' ? null : Number(el.value);
          } else {
            rec[k] = el.value;
          }
          saveCategory('recipes');
          syncRecipeYields();
        };
        tr.querySelector('button[data-act="del"]').onclick = () => {
          data.recipes.splice(idx, 1);
          saveCategory('recipes');
          syncRecipeYields();
          renderRecipes();
        };
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    // Synchronize recipe yields to prep items and to state
    function syncRecipeYields() {
      data.recipes.forEach(rec => {
        const pi = data.prepItems.find(pi => pi.id === rec.prepItemId);
        if (pi && rec.yieldAmount != null) {
          pi.unitCount = rec.yieldAmount;
        }
      });
      saveCategory('prepItems');
      if (typeof window.state !== 'undefined' && window.state.items) {
        data.prepItems.forEach(pi => {
          const itm = window.state.items.find(x => x.id === pi.id);
          if (itm) itm.default_batch_yield = pi.unitCount || null;
        });
        if (typeof window.persistAll === 'function') window.persistAll();
      }
    }
    /* ------------------ Menu Items ------------------ */
    function renderMenuItems() {
      const container = sections.menuItems;
      if (!container) return;
      container.innerHTML = '';
      const toolbar = document.createElement('div');
      toolbar.className = 'toolbar';
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Menu Item';
      addBtn.className = 'primary';
      addBtn.onclick = () => {
        data.menuItems.push({ id: `menu_${Date.now()}`, name: '', description: '', components: [] });
        saveCategory('menuItems');
        renderMenuItems();
      };
      const exportBtn = document.createElement('button');
      exportBtn.textContent = 'Export JSON';
      exportBtn.className = 'secondary';
      exportBtn.onclick = () => {
        downloadFile('menuItems.json', 'application/json', JSON.stringify(data.menuItems, null, 2));
      };
      const importLabel = document.createElement('label');
      importLabel.className = 'filelike';
      importLabel.textContent = 'Import JSON';
      const importInput = document.createElement('input');
      importInput.type = 'file';
      importInput.accept = 'application/json';
      importInput.onchange = async (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const txt = await f.text();
        try {
          data.menuItems = JSON.parse(txt);
        } catch (err) {
          alert('Failed to parse JSON');
          return;
        }
        saveCategory('menuItems');
        renderMenuItems();
      };
      importLabel.appendChild(importInput);
      toolbar.appendChild(addBtn);
      toolbar.appendChild(exportBtn);
      toolbar.appendChild(importLabel);
      container.appendChild(toolbar);
      const table = document.createElement('table');
      table.className = 'table';
      // Updated header: include Prep Items multi-select, Other/Garnish text, and Price
      table.innerHTML = '<thead><tr><th>Name</th><th>Description</th><th>Prep Items</th><th>Other/Garnish</th><th>Price</th><th></th></tr></thead>';
      const tbody = document.createElement('tbody');
      data.menuItems.forEach((mi, idx) => {
        // Ensure new fields exist
        if (mi.price === undefined) mi.price = null;
        if (!Array.isArray(mi.components)) mi.components = [];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="text" data-k="name" value="${mi.name || ''}"></td>
          <td><input type="text" data-k="description" value="${mi.description || ''}"></td>
          <td>
            <select multiple data-k="prepItems" style="min-width:140px"></select>
          </td>
          <td><textarea data-k="other" style="min-width:140px" placeholder="qty unit name | ..."></textarea></td>
          <td><input type="number" min="0" step="any" data-k="price" value="${mi.price ?? ''}"></td>
          <td><button data-act="del" class="secondary">Delete</button></td>
        `;
        const nameInput = tr.querySelector('input[data-k="name"]');
        const descInput = tr.querySelector('input[data-k="description"]');
        const priceInput = tr.querySelector('input[data-k="price"]');
        const prepSelect = tr.querySelector('select[data-k="prepItems"]');
        const otherArea = tr.querySelector('textarea[data-k="other"]');
        // Populate prep items select
        prepSelect.innerHTML = '';
        data.prepItems.forEach(pi => {
          const opt = document.createElement('option');
          opt.value = pi.id;
          opt.textContent = pi.name || pi.id;
          // select if this prep item is in components (prep)
          const compIdx = mi.components.findIndex(c => c.prepItemId === pi.id);
          if (compIdx !== -1) opt.selected = true;
          prepSelect.appendChild(opt);
        });
        // Populate other field with existing other/garnish components
        const otherComps = mi.components.filter(c => !c.prepItemId);
        otherArea.value = otherComps.map(c => `${c.qty ?? ''} ${c.unit ?? ''} ${c.name ?? ''}`.trim()).join(' | ');
        // Event handlers
        nameInput.addEventListener('input', () => { mi.name = nameInput.value; saveCategory('menuItems'); });
        descInput.addEventListener('input', () => { mi.description = descInput.value; saveCategory('menuItems'); });
        priceInput.addEventListener('input', () => {
          mi.price = priceInput.value === '' ? null : Number(priceInput.value);
          saveCategory('menuItems');
        });
        prepSelect.addEventListener('change', () => {
          const selectedIds = Array.from(prepSelect.selectedOptions).map(opt => opt.value);
          // Filter existing prep components by selectedIds or others
          const newComps = [];
          // Add selected prep items with default qty/unit or existing values
          selectedIds.forEach(id => {
            // find existing comp for this id
            const existing = mi.components.find(c => c.prepItemId === id);
            if (existing) {
              newComps.push({ ...existing });
            } else {
              const pi = data.prepItems.find(p => p.id === id);
              newComps.push({ prepItemId: id, qty: 1, unit: pi?.unit || '', name: pi?.name || '' });
            }
          });
          // include other comps from previous
          mi.components.filter(c => !c.prepItemId).forEach(c => newComps.push({ ...c }));
          mi.components = newComps;
          saveCategory('menuItems');
        });
        otherArea.addEventListener('input', () => {
          // Parse other/garnish text into components (qty unit name) separated by | or newline
          const text = otherArea.value;
          const parts = text.split(/\n|\|/).map(s => s.trim()).filter(Boolean);
          const otherCompsList = parts.map(seg => {
            const tokens = seg.split(/\s+/);
            let qty = null; let unit = '';
            if (tokens.length > 0) {
              const maybeNum = parseFloat(tokens[0]);
              if (!isNaN(maybeNum)) {
                qty = maybeNum;
                tokens.shift();
                if (tokens.length > 0) {
                  unit = tokens.shift();
                }
              }
            }
            const name = tokens.join(' ');
            return { qty: qty, unit: unit, name: name, prepItemId: null };
          });
          // Keep existing prep comps and update other comps
          const prepComps = mi.components.filter(c => c.prepItemId);
          mi.components = [...prepComps, ...otherCompsList];
          saveCategory('menuItems');
        });
        tr.querySelector('button[data-act="del"]').onclick = () => {
          data.menuItems.splice(idx, 1);
          saveCategory('menuItems');
          renderMenuItems();
        };
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }
    // Initialize with the first category active
    activateCategory('ingredients');
  })();
  </script>
  <!-- ExcelJS library for generating XLSX files with formatting -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
  <script>
    // Register service worker for offline caching
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .catch(function (err) { console.error('Service Worker registration failed:', err); });
    }
  </script>
</body>
</html>
